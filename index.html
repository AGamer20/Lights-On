<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lights On</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

        :root {
            --bg-color: #121212;
            --grid-bg: #1d1d1d;
            --cell-off: #333;
            --cell-on: #ffd700;
            --text-color: #f0f0f0;
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --extra-color: #ff8c00;
            --perfect-color: #28a745;
            --shadow-color: rgba(255, 215, 0, 0.5);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            z-index: 1;
        }
        
        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }

        h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.6), 0 0 10px rgba(255, 255, 255, 0.4);
        }

        h1 span {
            position: relative;
            z-index: 1;
        }

        h1 svg {
            height: 1.6em;
            margin-left: -15px;
            padding-bottom: 15px;
            transform: rotate(35deg);
            position: relative;
            z-index: 0;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
        }

        h2 { text-align: center; }

        .button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 1.2em;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s, background-color 0.2s;
        }
        .button:hover { transform: scale(1.05); }
        .button.secondary { background-color: var(--secondary-color); }
        .button.secondary:hover { background-color: #5a6268; }
        .button.dev-button { background-color: var(--extra-color); }
        .button.dev-button:hover { background-color: #e67e00; }

        #info-bar { display: flex; justify-content: space-between; width: 90vmin; max-width: 500px; font-size: 1.2em; font-weight: 600; }
        #grid-container {
            display: grid;
            gap: 10px;
            background-color: var(--grid-bg);
            padding: 15px;
            border-radius: 12px;
            width: 90vmin;
            height: 90vmin;
            max-width: 500px;
            max-height: 500px;
            margin: 20px 0;
            transition: grid-template-columns 0.3s ease;
        }
        .cell {
            background-color: var(--cell-off); border-radius: 8px; cursor: pointer;
            transition: transform 0.1s ease-out, background-color 0.2s ease;
        }
        .cell:active { transform: scale(0.95); }
        .cell.on { background-color: var(--cell-on); box-shadow: 0 0 20px var(--shadow-color); }
        #controls { display: flex; flex-wrap: wrap; justify-content: center; }

        /* --- RESPONSIVE LEVEL SELECT FIX --- */
        #level-select-screen .levels-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: clamp(5px, 2vw, 15px); /* Responsive gap */
            margin-top: 20px;
            width: 95vw;
            max-width: 500px;
        }
        .level-button {
            font-weight: 600;
            padding: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1; /* Makes the button a perfect square */
            width: 100%; /* Removes fixed width */
            height: auto; /* Removes fixed height */
        }
        .level-button .level-num { font-size: clamp(1rem, 5vw, 1.5em); } /* Responsive font size */
        .level-button .level-pb { font-size: clamp(0.5rem, 2.5vw, 0.7em); margin-top: 2px; } /* Responsive font size */
        .level-button.locked { background-color: #555; color: #888; cursor: not-allowed; transform: none !important; }
        .level-button.extra { background-color: transparent; border: 3px solid var(--extra-color); color: var(--extra-color); }
        .level-button.extra:hover { background-color: var(--extra-color); color: white; }
        .level-button.perfect { background-color: var(--perfect-color); border-color: var(--perfect-color); color: white; }
        .level-button.perfect:hover { background-color: #218838; }

        #win-modal {
            background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
            z-index: 10;
        }
        #win-modal-content { border-radius: 15px; padding: 30px; text-align: center; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game-screen" class="screen hidden">
            <div id="info-bar">
                <span id="level-display"></span>
                <span id="moves-display"></span>
            </div>
            <div id="grid-container"></div>
            <div id="controls">
                <button class="button" onclick="resetLevel()">Reset</button>
                <button class="button secondary" id="game-menu-btn">Menu</button>
                <button class="button dev-button" id="skip-level-btn">Skip (Test)</button>
            </div>
        </div>

        <div id="start-screen" class="screen hidden">
            <h1>
                <span>Lights On</span>
                <svg viewBox="0 0 114.98 122.88"><g><path fill="#5C546A" d="M68.72,116.34c-1.22,2.09-2.9,3.72-4.82,4.83c-1.71,1-3.62,1.57-5.53,1.69c-1.94,0.12-3.9-0.25-5.69-1.11 c-1.22-0.6-2.36-1.43-3.37-2.51L68.72,116.34L68.72,116.34L68.72,116.34z M71.41,95.83l-0.63,2.95l-0.16,2.1l-25.33,3.77 c-0.09-1.51-0.33-3.14-0.71-4.83L71.41,95.83L71.41,95.83L71.41,95.83z M70.57,105.48l0.02,1.27l0.03,0.44 c0.07,0.83,0.08,1.67,0.03,2.5l-0.38,1.83l-23.52,3.5l-0.41-0.94l-0.92-3.76l-0.02-1.09L70.57,105.48L70.57,105.48L70.57,105.48z"/><path d="M56.76,3.84c0.03-1.09,0.49-2.06,1.22-2.75c0.71-0.68,1.69-1.09,2.75-1.08V0c0.09,0,0.18,0.01,0.27,0.02 c0.99,0.08,1.88,0.53,2.52,1.2c0.68,0.71,1.09,1.68,1.08,2.75h0.01c0,0.07,0,0.14-0.01,0.2l-0.21,8.37l0.01,0 c0,0.09-0.01,0.18-0.02,0.27c-0.08,1-0.53,1.88-1.2,2.52c-0.72,0.68-1.69,1.09-2.75,1.08v0.01c-0.09,0-0.18-0.01-0.27-0.02 c-1-0.08-1.88-0.53-2.52-1.2c-0.68-0.72-1.09-1.69-1.08-2.75l-0.01,0c0-0.07,0-0.14,0.01-0.2L56.76,3.84L56.76,3.84L56.76,3.84z M14.26,18.5c-0.79-0.74-1.21-1.73-1.25-2.73c-0.04-1,0.31-2.02,1.04-2.81c0.74-0.79,1.73-1.21,2.73-1.25 c1-0.04,2.02,0.31,2.81,1.04l6.28,5.85c0.79,0.74,1.21,1.73,1.25,2.73c0.04,1.01-0.31,2.02-1.04,2.81 c-0.74,0.79-1.73,1.21-2.73,1.25c-1.01,0.04-2.02-0.31-2.81-1.04L14.26,18.5L14.26,18.5L14.26,18.5z M3.99,61.66 c-1.06,0.02-2.03-0.39-2.75-1.06c-0.73-0.69-1.2-1.65-1.24-2.74c-0.04-1.08,0.37-2.08,1.06-2.81c0.69-0.73,1.65-1.2,2.74-1.23 l8.57-0.29c1.08-0.04,2.08,0.37,2.81,1.06c0.73,0.69,1.2,1.65,1.23,2.74v0.06h0.01l-0.01,0.14c-0.02,1.01-0.42,1.92-1.06,2.61 c-0.69,0.73-1.65,1.19-2.74,1.23h-0.06v0.01h-0.09L3.99,61.66L3.99,61.66L3.99,61.66z M110.69,49.51l0.13-0.01 c1.02-0.06,1.97,0.27,2.71,0.87c0.78,0.63,1.31,1.57,1.43,2.64v0.04c0.01,0,0.01,0.11,0.01,0.13c0.06,1.02-0.27,1.97-0.87,2.71 c-0.63,0.78-1.57,1.31-2.64,1.43l-8.53,0.9c-1.08,0.11-2.1-0.23-2.87-0.86c-0.78-0.63-1.32-1.57-1.43-2.64 c-0.11-1.07,0.23-2.1,0.86-2.87c0.63-0.78,1.57-1.32,2.64-1.43C104.98,50.11,107.84,49.78,110.69,49.51L110.69,49.51L110.69,49.51 L110.69,49.51z M93.8,15.38c0.61-0.9,1.51-1.46,2.49-1.66c0.98-0.19,2.03-0.01,2.94,0.59l0.01,0.01c0.9,0.6,1.47,1.51,1.66,2.49 c0.19,0.98,0.01,2.03-0.59,2.94l-4.77,7.13c-0.6,0.9-1.51,1.47-2.5,1.67c-0.98,0.19-2.03,0.01-2.94-0.59 c-0.9-0.6-1.47-1.52-1.67-2.5c-0.19-0.98-0.01-2.03,0.59-2.94L93.8,15.38L93.8,15.38L93.8,15.38z"/><path fill="#F4BB2C" d="M36.37,82.46c-2.88-3.29-5.86-6.71-8.22-11.74c-2.31-4.96-3.59-10.08-3.55-15.4c0.05-5.32,1.4-10.8,4.34-16.46 c0.02-0.04,0.04-0.07,0.06-0.11l0,0c3.85-6.52,9.24-10.88,15.24-13.32c5.03-2.06,10.5-2.76,15.86-2.27 c5.34,0.49,10.57,2.17,15.14,4.87c5.81,3.44,10.59,8.54,13.22,14.98c1.42,3.49,2.38,7.38,2.5,11.64c0.12,4.25-0.61,8.83-2.57,13.67 c-3,7.43-10.01,15.39-14.6,22.7c-0.25-0.05-0.51-0.06-0.77-0.02l-6.19,0.92l9.43-32.79c0.27-0.93-0.28-1.9-1.21-2.17 c-0.93-0.26-1.9,0.28-2.17,1.21L63,92.49l-9.36,1.39l-9.89-31.43c0.71,0.14,1.46-0.17,1.85-0.83l7.01-11.93l3.57,8.19 c0.39,0.89,1.42,1.29,2.3,0.91c0.44-0.19,0.76-0.55,0.93-0.96l0,0l3.16-7.98l3.7,9.76c0.34,0.91,1.35,1.36,2.26,1.02 s1.36-1.35,1.02-2.26l-5.27-13.9c-0.15-0.49-0.52-0.91-1.03-1.11c-0.9-0.36-1.92,0.09-2.28,0.99l-3.27,8.27l-3.26-7.48 c-0.14-0.33-0.39-0.62-0.72-0.81c-0.83-0.49-1.91-0.21-2.39,0.62l-8.52,14.5l-0.61-1.93c-0.29-0.92-1.27-1.44-2.19-1.15 c-0.92,0.29-1.44,1.27-1.15,2.19L50.13,94.4l-6.78,1.01C41.72,90.56,39.22,85.72,36.37,82.46L36.37,82.46L36.37,82.46z"/></g></svg>
            </h1>
            <button class="button" id="start-game-btn">New Game</button>
            <button class="button secondary" id="reset-progress-btn">Reset Progress</button>
        </div>

        <div id="level-select-screen" class="screen hidden">
            <h2>4x4 Levels</h2>
            <div id="levels-grid-container-normal" class="levels-grid"></div>
            <h2>5x5 Extra Levels</h2>
            <div id="levels-grid-container-extra" class="levels-grid"></div>
            <button class="button" onclick="goToStartScreen()">Main Menu</button>
        </div>
        
        <div id="win-modal" class="screen hidden">
            <div id="win-modal-content">
                <h2 id="win-title"></h2>
                <p id="win-message"></p>
                <p id="win-par"></p>
                <button class="button" id="win-next-btn"></button>
            </div>
        </div>
    </div>

    <script>
        const levels = [
            { par: 2, size: 4, pattern: "1011000110101100" }, { par: 4, size: 4, pattern: "1110010001001110" },
            { par: 3, size: 4, pattern: "1010000111111111" }, { par: 4, size: 4, pattern: "1001100101101111" },
            { par: 5, size: 4, pattern: "1110110110100100" }, { par: 7, size: 5, pattern: "1111001010011100001100001" },
            { par: 8, size: 5, pattern: "0010010100101111001000010" }, { par: 9, size: 5, pattern: "0011110010101000011001111" },
            { par: 11, size: 5, pattern: "1111101111101101001101001" }, { par: 13, size: 5, pattern: "1010010100111000011101111" },
        ];
        
        const screens = Object.fromEntries(Array.from(document.querySelectorAll('.screen')).map(el => [el.id, el]));
        const gridContainer = document.getElementById('grid-container');
        const movesDisplay = document.getElementById('moves-display');
        const levelDisplay = document.getElementById('level-display');
        let audioCtx;

        let gameState = { currentLevel: 1, gridSize: 4, moves: 0, cells: [], progress: { highestLevelBeaten: 0, pbs: {} } };
        
        function showScreen(screenId) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[screenId].classList.remove('hidden');
        }
        
        function createGrid(size) {
            gridContainer.innerHTML = '';
            gameState.cells = [];
            gameState.gridSize = size;
            gridContainer.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

            for (let i = 0; i < size * size; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.addEventListener('click', () => handleCellClick(i));
                gridContainer.appendChild(cell);
                gameState.cells.push(cell);
            }
        }
        
        function loadLevel(levelNum) {
            const levelData = levels[levelNum - 1];
            if (gameState.gridSize !== levelData.size) { createGrid(levelData.size); }
            gameState.currentLevel = levelNum; gameState.moves = 0;
            gameState.cells.forEach((cell, i) => cell.classList.toggle('on', levelData.pattern[i] === '1'));
            updateUI();
        }

        function startGame(levelNum) { loadLevel(levelNum); showScreen('game-screen'); }
        function resetLevel() { loadLevel(gameState.currentLevel); }
        
        function handleCellClick(index) {
            gameState.moves++;
            const size = gameState.gridSize; const col = index % size;
            [index, index - size, index + size, (col > 0 ? index - 1 : -1), (col < size - 1 ? index + 1 : -1)]
                .filter(i => i >= 0 && i < size * size).forEach(i => gameState.cells[i].classList.toggle('on'));
            updateUI();
            if (gameState.cells.every(c => c.classList.contains('on'))) handleWin();
        }

        function triggerVibration(pattern) { if ('vibrate' in navigator) navigator.vibrate(pattern); }

        function handleWin() {
            triggerVibration([100, 50, 300, 50, 300, 150, 100, 50, 100, 150, 300, 50, 100]); // W-I-N
            gameState.progress.highestLevelBeaten = Math.max(gameState.progress.highestLevelBeaten, gameState.currentLevel);
            const currentPB = gameState.progress.pbs[gameState.currentLevel];
            if (!currentPB || gameState.moves < currentPB) { gameState.progress.pbs[gameState.currentLevel] = gameState.moves; }
            saveProgress();
            
            const par = levels[gameState.currentLevel - 1].par;
            document.getElementById('win-par').textContent = `Moves: ${gameState.moves} (Par: ${par})`;
            document.getElementById('win-message').textContent = gameState.moves <= par ? 'Excellent solve!' : 'Good job!';
            
            const winTitle = document.getElementById('win-title'), winNextBtn = document.getElementById('win-next-btn');
            
            if (gameState.currentLevel === 5 && gameState.progress.highestLevelBeaten === 5) {
                winTitle.textContent = 'Campaign Complete!';
                document.getElementById('win-message').innerHTML = 'You unlocked <b>Level Select</b><br>and <b>5x5 Extra Levels!</b>';
                winNextBtn.textContent = 'Go to Level Select';
                winNextBtn.onclick = () => { screens['win-modal'].classList.add('hidden'); showLevelSelect(); };
            } else if (gameState.currentLevel === levels.length) {
                winTitle.textContent = 'Congratulations!';
                document.getElementById('win-message').textContent = 'You have beaten all levels!';
                winNextBtn.textContent = 'Back to Level Select';
                winNextBtn.onclick = () => { screens['win-modal'].classList.add('hidden'); showLevelSelect(); };
            } else {
                winTitle.textContent = `Level ${gameState.currentLevel} Complete!`;
                winNextBtn.textContent = 'Next Level';
                winNextBtn.onclick = () => { screens['win-modal'].classList.add('hidden'); startGame(gameState.currentLevel + 1); };
            }
            screens['win-modal'].classList.remove('hidden');
        }

        function showLevelSelect() {
            const normCont = document.getElementById('levels-grid-container-normal'), xtraCont = document.getElementById('levels-grid-container-extra');
            [normCont, xtraCont].forEach(c => c.innerHTML = '');

            for (let i = 1; i <= levels.length; i++) {
                const levelData = levels[i-1], isUnlocked = i <= gameState.progress.highestLevelBeaten + 1;
                const pb = gameState.progress.pbs[i], btn = document.createElement('button');
                btn.innerHTML = `<span class="level-num">${i}</span><span class="level-pb">${pb ? `Best: ${pb}` : '---'}</span>`;
                btn.className = 'button level-button';
                if (!isUnlocked) btn.classList.add('locked');
                if (levelData.size === 5) btn.classList.add('extra');
                if (pb && pb <= levelData.par) btn.classList.add('perfect');
                if (isUnlocked) btn.onclick = () => startGame(i);
                (levelData.size === 4 ? normCont : xtraCont).appendChild(btn);
            }
            showScreen('level-select-screen');
        }

        function updateUI() {
            levelDisplay.textContent = `Level ${gameState.currentLevel}`;
            const par = levels[gameState.currentLevel - 1].par;
            movesDisplay.textContent = `Moves: ${gameState.moves} / Par: ${par}`;
            document.getElementById('game-menu-btn').onclick = (gameState.progress.highestLevelBeaten >= 5) ? showLevelSelect : goToStartScreen;
        }
        
        function goToStartScreen() {
            updateStartScreen();
            showScreen('start-screen');
        }

        function updateStartScreen() {
            const startBtn = document.getElementById('start-game-btn');
            const nextLevel = gameState.progress.highestLevelBeaten + 1;
            if (gameState.progress.highestLevelBeaten >= 5) {
                startBtn.textContent = 'Level Select';
                startBtn.onclick = showLevelSelect;
            } else if (nextLevel > 1 && nextLevel <= levels.length) {
                startBtn.textContent = `Continue (Level ${nextLevel})`;
                startBtn.onclick = () => startGame(nextLevel);
            } else {
                startBtn.textContent = 'New Game';
                startBtn.onclick = () => startGame(1);
            }
        }

        function saveProgress() { localStorage.setItem('lightsOnProgress', JSON.stringify(gameState.progress)); }
        function loadProgress() {
            const saved = localStorage.getItem('lightsOnProgress');
            if(saved) gameState.progress = JSON.parse(saved);
        }
        
        function main() {
            loadProgress();
            createGrid(4);
            updateStartScreen();
            
            document.getElementById('reset-progress-btn').onclick = () => {
                if (confirm('Are you sure you want to reset all your progress?')) {
                    localStorage.removeItem('lightsOnProgress');
                    location.reload();
                }
            };
            
            document.getElementById('skip-level-btn').onclick = () => {
                gameState.moves = levels[gameState.currentLevel - 1].par;
                handleWin();
            };

            document.body.addEventListener('click', () => {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }, { once: true });
            
            showScreen('start-screen');
        }

        main();
    </script>
</body>
</html>
